<!--
@license
Copyright (c) 2019 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../../vaadin-element-mixin/vaadin-element-mixin.html">
<link rel="import" href="vaadin-date-time-picker-custom-field.html">
<link rel="import" href="vaadin-date-time-picker-date-picker.html">
<link rel="import" href="vaadin-date-time-picker-time-picker.html">

<dom-module id="date-time-picker-custom-field" theme-for="vaadin-date-time-picker-custom-field">
  <template>
    <style>
      :host,
      .container {
        width: 100%;
      }
    </style>
  </template>
</dom-module>

<dom-module id="vaadin-date-time-picker">
  <template>
    <style>
      :host {
        display: inline-block;
      }

      :host([hidden]) {
        display: none !important;
      }

      .slot-container {
        display: flex;
      }

      [part="date"],
      .slot-container ::slotted([slot="date-picker"]) {
        min-width: 0;
        flex: 1 1 auto;
      }

      [part="time"],
      .slot-container ::slotted([slot="time-picker"]) {
        min-width: 0;
        flex: 1 1.65 auto;
      }
    </style>
    <vaadin-date-time-picker-custom-field
        id="customField"
        on-value-changed="__customFieldValueChanged"
        i18n="[[__customFieldValueFormat]]"
        theme$="[[theme]]"
      >
      <div class="slot-container">
        <slot name="date-picker">
          <vaadin-date-time-picker-date-picker part="date" theme$="[[theme]]"></vaadin-date-time-picker-date-picker>
        </slot>
        <slot name="time-picker">
          <vaadin-date-time-picker-time-picker part="time" theme$="[[theme]]"></vaadin-date-time-picker-time-picker>
        </slot>
      </div>
    </vaadin-date-time-picker-custom-field>
  </template>

  <script>
    (function() {

      /**
       * `<vaadin-date-time-picker>` is a Web Component providing a date time selection field.
       *
       * ```html
       * <vaadin-date-time-picker value="2019-09-16T15:00"></vaadin-date-time-picker>
       * ```
       *
       * ```js
       * dateTimePicker.value = '2019-09-16T15:00';
       * ```
       *
       * When the selected `value` is changed, a `value-changed` event is triggered.
       *
       * ### Styling
       *
       * The following shadow DOM parts are available for styling:
       *
       * Part name | Description | Theme for Element
       * ----------------|----------------|----------------
       * `date` | Date picker element | vaadin-date-time-picker
       * `time` | Time picker element | vaadin-date-time-picker
       *
       * See [ThemableMixin â€“ Stylable Shadow Parts](https://github.com/vaadin/vaadin-themable-mixin#stylable-shadow-parts)
       *
       * In addition to `<vaadin-date-time-picker>` itself, the following internal
       * components are themable:
       *
       * - `<vaadin-custom-field>`, see
       *   [`custom-field` documentation](https://vaadin.com/components/vaadin-custom-field/html-api/elements/Vaadin.CustomFieldElement)
       *   for the custom field parts.
       * - `<vaadin-date-picker>`, see
       *   [`date-picker` documentation](https://vaadin.com/components/vaadin-date-picker/html-api/elements/Vaadin.DatePickerElement)
       *   for the date picker parts.
       * - `<vaadin-time-picker>`, see
       *   [`time-picker` documentation](https://vaadin.com/components/vaadin-time-picker/html-api/elements/Vaadin.TimePickerElement)
       *   for the time picker parts.
       *
       * Note: the `theme` attribute value set on `<vaadin-date-time-picker>` is
       * propagated to the internal themable components listed above.
       *
       * @memberof Vaadin
       * @mixes Vaadin.ElementMixin
       * @mixes Vaadin.ThemableMixin
       * @mixes Vaadin.ThemePropertyMixin
       * @demo demo/index.html
       */
      class DateTimePicker extends Vaadin.ElementMixin(Vaadin.ThemableMixin(Polymer.Element)) {
        static get is() {
          return 'vaadin-date-time-picker';
        }
        static get version() {
          return '1.0.0-alpha2';
        }

        static get properties() {
          return {
            /**
             * The value for this element.
             *
             * Supported date time format is based on ISO 8601 (without a time zone designator):
             * - Minute precision `"YYYY-MM-DDThh:mm"`
             * - Second precision `"YYYY-MM-DDThh:mm:ss"`
             * - Millisecond precision `"YYYY-MM-DDThh:mm:ss.fff"` (default)
             */
            value: {
              type: String,
              notify: true,
              value: '',
              observer: '__valueChanged'
            },

            /**
             * The current selected date time.
             */
            __selectedDateTime: {
              type: Date
            },

            __customFieldValueFormat: {
              type: Object,
              value: () => ({
                parseValue: combinedValue => combinedValue.split('T'),
                formatValue: inputValues => inputValues.join('T')
              })
            }
          };
        }

        static get observers() {
          return [
            '__selectedDateTimeChanged(__selectedDateTime)'
          ];
        }

        __parseDate(str) {
          return customElements.get('vaadin-date-time-picker-date-picker').prototype._parseDate(str);
        }

        __formatDateISO(str) {
          return customElements.get('vaadin-date-time-picker-date-picker').prototype._formatISO(str);
        }

        __formatTimeISO(time) {
          return customElements.get('vaadin-time-picker').properties.i18n.value().formatTime(time);
        }

        __parseTimeISO(str) {
          return customElements.get('vaadin-time-picker').properties.i18n.value().parseTime(str);
        }

        __parseDateTime(str) {
          const [dateValue, timeValue] = str.split('T');
          if (!(dateValue && timeValue)) {
            return;
          }

          /** @type {Date} */
          const date = this.__parseDate(dateValue);
          if (!date) {
            return;
          }

          const time = this.__parseTimeISO(timeValue);
          if (!time) {
            return;
          }

          date.setHours(parseInt(time.hours));
          date.setMinutes(parseInt(time.minutes || 0));
          date.setSeconds(parseInt(time.seconds || 0));
          date.setMilliseconds(parseInt(time.milliseconds || 0));

          return date;
        }

        /**
         * @param {Date} date1
         * @param {Date} date2
         */
        __dateTimeEquals(date1, date2) {
          if (!Vaadin.DatePickerHelper._dateEquals(date1, date2)) {
            return false;
          }
          return date1.getHours() === date2.getHours() &&
          date1.getMinutes() === date2.getMinutes() &&
          date1.getSeconds() === date2.getSeconds() &&
          date1.getMilliseconds() === date2.getMilliseconds();
        }

        __handleDateTimeChange(property, parsedProperty, value, oldValue) {
          if (!value) {
            this[property] = '';
            this[parsedProperty] = '';
            return;
          }

          const dateTime = this.__parseDateTime(value);
          if (!dateTime) { // Invalid date, revert to old value
            this[property] = oldValue;
            return;
          }
          if (!this.__dateTimeEquals(this[parsedProperty], dateTime)) {
            this[parsedProperty] = dateTime;
          }
        }

        __valueChanged(value, oldValue) {
          // Setting initial value to empty string, skip
          if (value === '' && oldValue === undefined) {
            return;
          }

          this.__handleDateTimeChange('value', '__selectedDateTime', value, oldValue);
        }

        /**
         * FIXME(haprog): This method can probably be removed once we support "step" property
         * and know what the precision of the date string should be.
         *
         * @param {string} date1
         * @param {string} date2
         */
        __dateTimeStringEquals(date1, date2) {
          if (date1.length === date2.length) {
            return date1 === date2;
          }

          let shortDate, longDate;
          /* istanbul ignore else */
          if (date1.length < date2.length) {
            shortDate = date1;
            longDate = date2;
          } else {
            shortDate = date2;
            longDate = date1;
          }

          if (shortDate !== longDate.substr(0, shortDate.length)) {
            return false;
          }

          const endDiff = longDate.substr(shortDate.length);
          const okEndDiffs = [
            ':00.000',
            ':00',
            '.000'
          ];
          return okEndDiffs.indexOf(endDiff) !== -1;
        }

        __selectedDateTimeChanged(selectedDateTime) {
          /* istanbul ignore if */
          if (!selectedDateTime === undefined) {
            return;
          }

          const dateValue = this.__formatDateISO(selectedDateTime);
          // FIXME(haprog): Once we add support for "step" property, timeValue should take that into account
          // and use correct precision (like in vaadin-time-picker)
          const timeValue = (selectedDateTime && this.__formatTimeISO({
            hours: selectedDateTime.getHours(),
            minutes: selectedDateTime.getMinutes(),
            seconds: selectedDateTime.getSeconds(),
            milliseconds: selectedDateTime.getMilliseconds()
          })) || '';

          const formattedValue = `${dateValue}T${timeValue}`;
          if (!this.__dateTimeStringEquals(this.value, formattedValue)) {
            this.value = formattedValue;
          }

          // Setting the customField.value below triggers validation of the date picker and time picker.
          // If the inputs are slotted (e.g. when using the Java API) and have an initial value this can
          // happen before date picker ready() which triggers an error when date picker is trying to read
          // `this.$.input` (as a result of value change triggered by setting custom field value).
          // Workaround the problem by overriding customField.validate while setting the initial value.
          if (!this.$.customField.inputs[0].$) {
            const validate = this.$.customField.validate;
            /* istanbul ignore next */
            this.$.customField.validate = () => true;

            this.$.customField.value = this.value;

            this.$.customField.validate = validate;
            setTimeout(() => {
              this.$.customField.validate();
            });
          } else {
            this.$.customField.value = this.value;
          }
        }

        __customFieldValueChanged(e) {
          /** @type {string} */
          const value = e.detail.value;
          /* istanbul ignore if */
          if (typeof value !== 'string') {
            return;
          }

          // Initial empty value from custom field
          if (value === 'T' && !this.__customFieldInitialValueChangeReceived) {
            this.__customFieldInitialValueChangeReceived = true;
            // Ignore initial value from custom field so we don't override initial value of date time picker
            return;
          }

          const [date, time] = value.split('T');
          if (date && time) {
            if (!this.__dateTimeStringEquals(this.value, value)) {
              this.value = value;
            }
          } else {
            this.value = '';
          }
        }
      }

      customElements.define(DateTimePicker.is, DateTimePicker);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.DateTimePicker = DateTimePicker;
    })();
  </script>
</dom-module>
